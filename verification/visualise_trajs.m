addpath('../external')

%addpath('/mnt/data/SPT_method/simu/fullcell/simus/regions/1');
addpath('/tmp/toto')

outdir = '/tmp/simu_fullcell';
if ~isfolder(outdir)
    mkdir(outdir)
end

%addpath('/mnt/data/SPT_method/simu/fullcell/simus/regions/1')
[bp, dp] = polys();


start_b = [];
if exist('start_box.m', 'file') == 2
    start_b = start_box();
end

stop_b = [];
if exist('stop_box.m', 'file') == 2
    stop_b = stop_box();
end

%tab = dlmread('/tmp/sim/trajs_empirical_DT=0.006000_lambdaNpts=0.090909.csv', ',');
%tab = dlmread('/mnt/data/SPT_method/simu/fullcell/simus/ER9_VERYNICE_MMStack_Pos0.ome_Simple Segmentation_cleaned_binary_poly.poly_0.05_15/trajs.csv');
%tab = dlmread('/mnt/data/SPT_method/simu/fullcell/simus/regions/1/trajs.csv', ',');
tab = dlmread('trajs.csv', ',');

% figure
% hold on
% for i=1:length(bp)
%     plot(bp{i}([1:size(bp{i}, 1) 1],1), bp{i}([1:size(bp{i}, 1) 1],2), 'k')
%     for j=1:length(dp{i})
%         plot(dp{i}{j}([1:size(dp{i}{j}, 1) 1], 1), dp{i}{j}([1:size(dp{i}{j}, 1) 1], 2), 'k')
%     end
% end
% 
% if ~isempty(start_b)
%     plot([start_b(1,1), start_b(2,1)], [1 1] * start_b(1,2), 'r', 'LineWidth', 2)
%     plot([start_b(1,1), start_b(2,1)], [1 1] * start_b(2,2), 'r', 'LineWidth', 2)
%     plot([1 1] * start_b(1,1), [start_b(1,2), start_b(2,2)], 'r', 'LineWidth', 2)
%     plot([1 1] * start_b(2,1), [start_b(1,2), start_b(2,2)], 'r', 'LineWidth', 2)
% end
% if ~isempty(stop_b)
%     plot([stop_b(1,1), stop_b(2,1)], [1 1] * stop_b(1,2), 'm', 'LineWidth', 2)
%     plot([stop_b(1,1), stop_b(2,1)], [1 1] * stop_b(2,2), 'm', 'LineWidth', 2)
%     plot([1 1] * stop_b(1,1), [stop_b(1,2), stop_b(2,2)], 'm', 'LineWidth', 2)
%     plot([1 1] * stop_b(2,1), [stop_b(1,2), stop_b(2,2)], 'm', 'LineWidth', 2)
% end
% 
% Utils.show_trajectories(tab);
% hold off
% daspect([1 1 1])
% 
% 
% frames = 0:4999;
% cnts = zeros(length(frames), 1);
% for i=1:length(frames)
%     cnts(i) = sum(round(tab(:,2) ./ 0.006) == frames(i));
% end
% 
% figure
% plot(frames, cnts)
% 
% figure
% hist(Utils.displacements(tab) / 0.006, 1:2:101)
% 
% figure
% hold on
% for k=unique(tab(:,1))'
%     tr = tab(tab(:,1) == k, :);
%     
%     plot(tr(1,3), tr(1,4), 'xk')
%     for l=1:(size(tr, 1)-1)
%         if sqrt(sum((tr(l+1, 3:4) - tr(l, 3:4)).^2)) > 0.6
%             plot(tr([l, l+1], 3), tr([l, l+1], 4))
%         end
%     end
% end
% hold off
% daspect([1, 1, 1])



% poly = [1004.1 246;
% 997.3 246.1;
% 990.5 246.1;
% 986 247.6;
% 981.5 249;
% 979.3 249;
% 977.1 249;
% 974.6 251.2;
% 972.1 253.5;
% 971.4 256.2;
% 970.8 258.9;
% 973.4 261.4;
% 975.9 264;
% 977 264;
% 978 264;
% 979.9 262.1;
% 981.8 260.2;
% 984.4 260.7;
% 987 261.2;
% 988.5 260;
% 990 258.8;
% 989.4 256.4;
% 988.8 254;
% 990 254;
% 991.2 254;
% 991.7 256;
% 992.2 258;
% 993.4 258;
% 994.5 258;
% 1000 255.2;
% 1005.5 252.5;
% 1005.2 250.5;
% 1004.9 248.5;
% 1004.5 247.2;
% 1004.1 246];
% 



poly = [73.82025, 24.381;
73.788, 24.381;
73.75575, 24.38745;
73.5171, 24.5358;
73.27845, 24.6777;
73.143, 24.80025;
73.014, 24.91635;
73.014, 25.05825;
73.014, 25.2066;
73.11075, 25.284;
73.2075, 25.3614;
73.2075, 25.44525;
73.2075, 25.5291;
73.1043, 25.61295;
73.0011, 25.6968;
72.7818, 25.57425;
72.55605, 25.45815;
72.3303, 25.56135;
72.10455, 25.671;
72.04005, 25.671;
71.97555, 25.671;
71.7111, 25.8;
71.4531, 25.92255;
71.33055, 25.8645;
71.21445, 25.8;
71.0532, 25.8;
70.89195, 25.8;
70.7178, 25.9548;
70.5372, 26.10315;
70.62105, 26.30955;
70.7049, 26.5095;
70.75005, 26.5095;
70.78875, 26.50305;
71.0145, 26.32245;
71.24025, 26.1354;
71.31765, 26.4321;
71.39505, 26.73525;
71.4015, 26.81265;
71.4015, 26.89005;
71.14995, 26.961;
70.8984, 27.0255;
70.85325, 27.2835;
70.8081, 27.5415;
70.95, 27.83175;
71.0919, 28.122;
71.20155, 28.122;
71.3112, 28.122;
71.5821, 28.251;
71.85945, 28.38645;
71.82075, 28.4445;
71.78205, 28.509;
71.57565, 28.509;
71.3757, 28.509;
71.43375, 28.56705;
71.49825, 28.61865;
71.7111, 28.6896;
71.92395, 28.76055;
72.06585, 28.70895;
72.20775, 28.65735;
72.33675, 28.7025;
72.46575, 28.74765;
72.64635, 28.6896;
72.8205, 28.6251;
72.8205, 28.56705;
72.8205, 28.50255;
72.7302, 28.4703;
72.6399, 28.43805;
72.3948, 28.50255;
72.14325, 28.5735;
72.02715, 28.45095;
71.9046, 28.3284;
72.2271, 28.2252;
72.5496, 28.11555;
72.65925, 27.993;
72.77535, 27.864;
72.94305, 27.864;
73.1172, 27.864;
73.45905, 27.5157;
73.80735, 27.1674;
73.7622, 27.00615;
73.7235, 26.83845;
73.52355, 26.7417;
73.33005, 26.64495;
73.2978, 26.73525;
73.26555, 26.8191;
73.1172, 26.8578;
72.9753, 26.89005;
72.8463, 27.1287;
72.72375, 27.36735;
72.46575, 27.4512;
72.20775, 27.5415;
71.93685, 27.6834;
71.6595, 27.8253;
71.58855, 27.75435;
71.5176, 27.6834;
71.5692, 27.58665;
71.62725, 27.4899;
72.0981, 27.09645;
72.56895, 26.703;
72.6141, 26.703;
72.6657, 26.703;
72.89145, 26.49015;
73.12365, 26.27085;
73.3623, 25.9548;
73.60095, 25.6452;
73.5687, 25.5033;
73.53, 25.36785;
73.659, 25.25175;
73.78155, 25.1421;
73.8396, 25.1808;
73.9041, 25.2195;
74.0718, 25.08405;
74.2395, 24.95505;
74.2395, 24.86475;
74.2395, 24.77445;
74.0331, 24.58095;
73.82025, 24.381];

poly = [72, 30;
72, 25.8;
71.21445, 25.8;
71.0532, 25.8;
70.89195, 25.8;
70, 25.8;
70, 30;
72, 30];



bad_p = [71.0532001, 30.894131];

figure
hold on
for k=1:(size(poly, 1)-1)
    plot(poly([k k+1], 1), poly([k k+1], 2), 'k')
    p = poly(k,:) + (poly(k+1,:) - poly(k,:)) / 2;
    v = poly(k+1,:) - poly(k,:);
    n = sqrt(sum(v.^2));
    norm =  [-v(2) / n, v(1) / n];
    %plot(p(1), p(2), 'xr')
    
    %plot([p(1) p(1) + norm(1) * 0.5], [p(2) p(2) + norm(2) * 0.5], 'm')
end
plot(bad_p(1), bad_p(2), 'xr')
plot(bad_p(1) * [1 1], [bad_p(2) 25], 'r')

plot([71.0532,70.89195],[25.8,25.8], 'm', 'LineWidth', 2)
plot([70,72],[30,30], 'c', 'LineWidth', 2)

hold off
daspect([1 1 1])


p1 = [18.6163329, 47.2882678];
p2 = [18.6231109, 47.2991921];
%p3 = [40.010775303084, 50.8285459110254];
sp1 = [18.80175, 47.214];
sp2 = [18.5373, 47.33655];
figure
hold on
plot(p1(1), p1(2), 'x');
plot(p2(1), p2(2), 'o');
%plot(p3(1), p3(2), '*');
plot([sp1(1) sp2(1)], [sp1(2) sp2(2)])
hold off
daspect([1 1 1])

poly = [110.5, 62.8;
105, 62.4;
99.4, 62;
97.8, 63.6;
96.2, 65.3;
97.2, 67;
98.3, 68.7;
95.7, 72.2;
93, 75.7;
93, 77.4;
93, 79.1;
94.5, 81.9;
95.9, 84.8;
94.2, 86.2;
92.5, 87.7;
90.8, 88.3;
89.2, 88.9;
88.6, 88.3;
88, 87.7;
89, 86.5;
89.9, 85.4;
89.3, 81.6;
88.7, 77.9;
86.3, 82.1;
83.9, 86.3;
85.1, 87;
86.2, 87.8;
85, 91.4;
83.8, 95;
81.9, 96;
80, 97.1;
80, 102.5;
80, 107.9;
81.1, 108.5;
82.1, 109.2;
83.9, 107.6;
85.7, 106;
87.3, 106;
89, 106;
89, 105;
89, 104;
90.8, 104;
92.6, 104;
93.5, 104.9;
94.5, 105.8;
96.8, 106.5;
99, 107.1;
99, 105;
99, 102.9;
98, 101;
97, 99.2;
93.8, 98.5;
90.5, 97.8;
89.8, 97.4;
89.2, 97;
90.3, 93.7;
91.5, 90.5;
91.6, 90.2;
91.7, 90;
94.8, 91.6;
98, 93.1;
99.2, 94.9;
100.5, 96.7;
102.7, 97.8;
104.9, 99;
108.3, 99;
111.7, 99;
116.3, 97;
120.8, 95;
121.4, 93.4;
122, 91.9;
119.9, 87.8;
117.9, 83.8;
118.4, 82.5;
118.9, 81.2;
116.9, 79.4;
114.9, 77.6;
112.8, 77.5;
110.7, 77.5;
110.3, 76.3;
109.9, 75.1;
112.4, 74.4;
115, 73.8;
115, 72.8;
115, 71.8;
113, 69;
111, 66.2;
111.6, 64.6;
112.2, 63;
111.4, 62.9;
110.5, 62.8];


figure
hold on
plot(poly(:,1), poly(:,2), 'k')
plot([92.5,90.8],[87.7,88.3], 'c', 'LineWidth', 2)
plot([90.8,92.6],[104,104], 'c', 'LineWidth', 2)
plot([93.8,90.5],[98.5,97.8], 'c', 'LineWidth', 2)
plot(91.7 * [1 1], 104.005 * [1 0], 'r')
hold off
daspect([1 1 1])



for k=1%unique(tab(:,1))'
    figure%('Visible', 'off')
    hold on
    for i=1:length(bp)
        plot(bp{i}([1:size(bp{i}, 1) 1],1), bp{i}([1:size(bp{i}, 1) 1],2), 'k')
%         for kk=1:(size(bp{i}, 1)-1)
%             p = bp{i}(kk,:) + (bp{i}(kk+1,:) - bp{i}(kk,:)) / 2;
%             v = bp{i}(kk+1,:) - bp{i}(kk,:);
%             n = sqrt(sum(v.^2));
%             norm =  [-v(2) / n, v(1) / n];
%             %plot(p(1), p(2), 'xr')
%             plot([p(1) p(1) + norm(1) * 0.005], [p(2) p(2) + norm(2) * 0.005], 'm')
%         end
        for j=1:length(dp{i})
            plot(dp{i}{j}([1:size(dp{i}{j}, 1) 1], 1), dp{i}{j}([1:size(dp{i}{j}, 1) 1], 2), 'k')
%             for kk=1:(size(dp{i}{j})-1)
%                 p = dp{i}{j}(kk,:) + (dp{i}{j}(kk+1,:) - dp{i}{j}(kk,:)) / 2;
%                 v = dp{i}{j}(kk+1,:) - dp{i}{j}(kk,:);
%                 n = sqrt(sum(v.^2));
%                 norm =  [-v(2) / n, v(1) / n];
%                 plot([p(1) p(1) + norm(1) * 0.1], [p(2) p(2) + norm(2) * 0.1], 'b')
%             end
        end
    end

%     tr = tab(tab(:,1) == k, :);
%     cm = jet(size(tr, 1) - 1);
%     for i=1:(size(tr,1)-1)
%         plot(tr([i i+1], 3), tr([i i+1], 4), 'Color', cm(i, :), 'LineWidth', 0.2)
%     end

    %plot([67.6094063, 67.6089001], [21.2413533 21.2256399], 'b', 'LineWidth', 2)
    %Utils.show_trajectories(tab(tab(:,1) == k, :));
    plot(44.3165149, 57.9196315, 'x')
    plot(44.3179501, 57.9195661, 'o')
    
    if ~isempty(start_b)
        plot([start_b(1,1), start_b(2,1)], [1 1] * start_b(1,2), 'r', 'LineWidth', 2)
        plot([start_b(1,1), start_b(2,1)], [1 1] * start_b(2,2), 'r', 'LineWidth', 2)
        plot([1 1] * start_b(1,1), [start_b(1,2), start_b(2,2)], 'r', 'LineWidth', 2)
        plot([1 1] * start_b(2,1), [start_b(1,2), start_b(2,2)], 'r', 'LineWidth', 2)
    end
    if ~isempty(stop_b)
        plot([stop_b(1,1), stop_b(2,1)], [1 1] * stop_b(1,2), 'm', 'LineWidth', 2)
        plot([stop_b(1,1), stop_b(2,1)], [1 1] * stop_b(2,2), 'm', 'LineWidth', 2)
        plot([1 1] * stop_b(1,1), [stop_b(1,2), stop_b(2,2)], 'm', 'LineWidth', 2)
        plot([1 1] * stop_b(2,1), [stop_b(1,2), stop_b(2,2)], 'm', 'LineWidth', 2)
    end
    hold off
    daspect([1 1 1])
    %tightfig();
    %print(sprintf('%s/trajs_%d.png', outdir, k), '-dpng', '-r1000')
    %pause(5);
    %close all;
end